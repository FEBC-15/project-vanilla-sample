# 13장 API 서버 사용 가이드

- API 호출 URL: `https://fesp-api.koyeb.app/market`
- API 변경 사항 확인: https://fesp-api.koyeb.app/market
- API 문서: https://fesp-api.koyeb.app/market/apidocs

## 1. 오픈마켓 API 서버

- 제공되는 API 서버를 사용해서 FrontEnd를 완성하면 됩니다.
- API 서버의 주제는 오픈마켓이며 게시판 관리, 회원 관리, 상품 관리, 구매 관리, 후기 관리 등의 기능이 제공됩니다.
- API 서버는 대부분의 오픈 마켓에 적합하도록 범용적으로 제작되어 있어서 여러분이 구현하고 싶은 기능이 일부 제공되지 않을 수 있습니다.
- API에서 제공되지 않는 기능은 개발을 요청해 주세요. 검토후 최대한 빠른 시간내로 추가하겠습니다.

## 2. API 서버 구현 기술

- Application Server: Node.js + Express
- Database: MongoDB

## 3. DB 초기화

- API 서버가 사용하는 DB에 데이터 일부를 미리 추가해 두어야 API를 원활히 사용할 수 있으므로 이를 위해 초기화 스크립트를 실행

### 3.1 DB 초기화 파일 다운로드

- 프로젝트 루트 폴더에서 실행하면 api/dbinit/brunch나 api/dbinit/nike 폴더에 DB 초기화 파일이 다운로드 됨
- 이전에 다운로드한 파일을 덮어씌우려면 --force 옵션 추가

- DB 초기화 파일 다운로드(브런치 스토리)

  ```sh
  npx degit https://github.com/FEBC-API/APIServer/api/dbinit/brunch api/dbinit/readonly-brunch --force
  npx degit https://github.com/FEBC-API/APIServer/api/dbinit/brunch api/dbinit/team-brunch --force
  ```

- DB 초기화 파일 다운로드(나이키)

  ```sh
  npx degit https://github.com/FEBC-API/APIServer/api/dbinit/nike api/dbinit/readonly-nike --force
  npx degit https://github.com/FEBC-API/APIServer/api/dbinit/nike api/dbinit/team-nike --force
  ```

## 4. API 서버 테스트
- Bruno는 Postman과 유사한 UI를 제공하는 오픈소스 API 테스트 도구
- Postman과 차별점
  - API 요청 정보를 클라우드에 저장하지 않고 로컬의 파일 시스템에 저장
  - Git과 같은 버전 관리 도구와 쉽게 통합되어 협업이 가능

### 4.1 Bruno 설치

- https://www.usebruno.com/downloads 접속 후 본인의 OS에 맞는 버전 다운로드 후 기본 설정 그대로 설치

### 4.2 Collection 생성
- 좌측 상단의 bruno 로고(🐶) 클릭
- COLLECTIONS > Create Collection
  - Name: `test-brunch`
  - Location: project-vanilla-sample/api/bruno
  - Folder Name: test-brunch
  - Create

### 4.3 환경 변수 추가

- test-brunch Collection 선택
  - 팝업창이 뜨면 Safe Mode 선택 후 Save
- Bruno 우측 상단의 No Environment > Create
  - Environment Name: prod
    - Create
  - Add variable
    - Name: `url`
    - Value: `https://fesp-api.koyeb.app/market`
  - Add variable
    - Name: `client-id`
    - Value: `brunch`
  - Save

### 4.4 게시물 목록 조회 테스트

- test-brunch 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `게시물 목록 조회`
  - URL: GET, `{{url}}/posts`
  - Create
- Params > Add Param
  - Name: type
  - Value: brunch
- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송
- 결과 확인

  ```json
  {
    "ok": 0,
    "message": "client-id 헤더가 없습니다."
  }
  ```

### 4.5 헤더에 client-id 추가

- 매 요청시 헤더값으로 client-id를 자동으로 보내기 위한 설정

- test-brunch 컬렉션에 마우스 올린 후 더보기(...) > Settings > Headers > Add Header
  - Name: `client-id`
  - Value: `{{client-id}}`
  - Save

- [게시물 목록 조회] 테스트

### 4.6 게시물 북마크 추가 테스트

- test-brunch 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `게시물 북마크 추가`
  - URL: POST, `{{url}}/bookmarks/post`
  - Create

- Body > No Body 선택 후 JSON으로 수정 후 입력

  ```json
  {
    "target_id": 3,
    "memo": "게시판 사용법 북마크"
  }
  ```

- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송

- 에러 확인

  - 로그인 후에 사용할 수 있는 API 이므로 로그인이 선행되어야 함.

  ```json
  {
    "ok": 0,
    "message": "authorization 헤더가 없습니다.",
    "errorName": "EmptyAuthorization"
  }
  ```

### 4.7 로그인 테스트

- test-brunch 컬렉션에 마우스 올린 후 더보기(...) > New Request
  - Type: HTTP
  - Request Name: `로그인`
  - URL: POST, `{{url}}/users/login`
  - Create

- Body > No Body 선택 후 JSON으로 수정 후 입력

  ```json
  {
    "email": "w1@market.com",
    "password": "11111111"
  }
  ```

- URL 우측에 있는 **화살표(->)** 클릭해서 요청 전송

- Response 확인
  - 로그인 성공시 응답데이터에 JWT 토큰이 item.token.accessToken, item.token.refreshToken 속성으로 전달됨
  - 로그인이 필요한 API 요청시 사용자 인증을 위해서 authorization 헤더에 accessToken을 전달해야 함

```json
{
  "ok": 1,
  "item": {
    "_id": 2,
    "email": "w1@market.com",
    "name": "AB",
    "type": "seller",
    "loginType": "email",
    "image": "https://res.cloudinary.com/ddedslqvv/image/upload/v1762755121/brunch/BJo-jUA_wX.webp",
    "extra": {
      "job": "마케터",
      "biography": "서른살, 새내기 취준생",
      "keyword": [
        "취업",
        "노션",
        "포트폴리오"
      ]
    },
    "createdAt": "2025.11.10 16:51:44",
    "updatedAt": "2025.11.10 16:51:44",
    "notifications": [],
    "token": {
      "accessToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOjIsInR5cGUiOiJzZWxsZXIiLCJuYW1lIjoiQUIiLCJlbWFpbCI6IncxQG1hcmtldC5jb20iLCJpbWFnZSI6Imh0dHBzOi8vcmVzLmNsb3VkaW5hcnkuY29tL2RkZWRzbHF2di9pbWFnZS91cGxvYWQvdjE3NjI3NTUxMjEvYnJ1bmNoL0JKby1qVUFfd1gud2VicCIsImxvZ2luVHlwZSI6ImVtYWlsIiwiaWF0IjoxNzYyNzc4NDEwLCJleHAiOjE3NjI4NjQ4MTAsImlzcyI6IkZFQkMifQ.XS--GpoA9WgS6ryuy33zk9sCnwL2MCPrp7aapTLUD8A",
      "refreshToken": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpYXQiOjE3NjI3Nzg0MTAsImV4cCI6MTc2NTM3MDQxMCwiaXNzIjoiRkVCQyJ9.rcszVBErux6uKYjVCfBYADQXmERVcJSkDUu_Mg7rw4k"
    }
  }
}
```

### 4.8 Collection에 로그인 스크립트 추가

#### 토큰값 저장
- 로그인 성공 후 받은 토큰값을 환경 변수에 저장

- [로그인] 요청의 Script 탭 선택
  - 다음 코드를 Response에 추가 후 저장

  ```js
  // 로그인 성공 후
  if(res.status === 200){
    bru.setEnvVar('accessToken', res.body.item.token.accessToken);
    bru.setEnvVar('refreshToken', res.body.item.token.refreshToken);
  }
  ```

- [로그인] 요청 후에 환경 변수값 accessToken, refreshToken이 생성되었는지 확인
  - Bruno 우측 상단의 prod > Configure 선택한 후 accessToken, refreshToken 변수 확인 후 닫기

#### 요청 헤더에 토큰 인증 정보 추가

- 환경 변수에 추가한 토큰을 요청 헤더에 자동으로 추가

- test-brunch 컬렉션에 마우스 올린 후 더보기(...) > Settings
  - Auth > No Auth 클릭해서 Bearer Token 선택
  - Token: `{{accessToken}}`
  - Save

### 4.9 게시물 북마크 추가 테스트

- [게시물 북마크 추가] > Auth > `No Auth`일 경우 `Inherit` 변경 후 요청 전송
  - 결과 확인
  ```json
  {
    "ok": 1,
    "item": {
      "type": "post",
      "user_id": 2,
      "target_id": 3,
      "user": {
        "_id": 2,
        "name": "AB",
        "email": "w1@market.com",
        "image": "https://res.cloudinary.com/ddedslqvv/image/upload/v1762755121/brunch/BJo-jUA_wX.webp"
      },
      "memo": "게시판 사용법 북마크",
      "_id": 11,
      "createdAt": "2025.11.11 10:46:00"
    }
  }
  ```

### 4.10 샘플 Bruno 파일 다운로드

- 프로젝트 루트 폴더에서 실행하면 api/bruno/brunch나 api/bruno/nike 폴더에 다운로드 됨
- 이전에 다운로드한 파일을 덮어씌우려면 --force 옵션 추가

- 샘플 Bruno 파일 다운로드(브런치 스토리)

  ```sh
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/brunch api/bruno/readonly-brunch --force
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/brunch api/bruno/team-brunch --force
  ```

- 샘플 Bruno 파일 다운로드(나이키)

  ```sh
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/nike api/bruno/readonly-nike --force
  npx degit https://github.com/FEBC-API/APIServer/api/bruno/nike api/bruno/team-nike --force
  ```

- Bruno > Collection > Open Collection으로 다운로드한 컬렉션 추가 후 테스트

## 5. 팀 프로젝트에 적용
- 디스코드 팀 채널에서 팀원중 한명이 화면 공유해서 진행

### 5.1 팀 프로젝트 DB 초기화
- 팀 프로젝트 폴더에서 [3. DB 초기화](#3-db-초기화) 작업 수행
- api/dbinit/team-brunch, api/dbinit/team-nike 폴더의 파일을 팀에 맞게 수정 후 [DB 초기화 API](https://fesp-api.koyeb.app/market/apidocs/#/%EC%8B%9C%EC%8A%A4%ED%85%9C/post_db_init) 작업 실행
  - Bruno의 readonly-brunch, readonly-nike의 `00-DB초기화` 폴더 참고

### 5.2 팀 프로젝트 API 서버 테스트
- 팀 프로젝트 폴더에서 [4.10 샘플 Bruno 파일 다운로드](#410-샘플-bruno-파일-다운로드) 작업 수행
- Bruon의 team-brunch, team-nike 컬렉션 선택 후 환경변수 prod의 client-id는 각 팀에게 부여된 값 `febc15-vanilla팀번호-ecad`으로 수정
  - 5팀 예시, `febc15-vanilla05-ecad`

#### 팀 레포지토리에 반영
- 수행한 작업에 대한 PR 생성 후 push

#### 담당 기능에 대한 API 테스트
- 팀원은 pull 받은 후 Bruno > Collection > Open Collection으로 team-brunch, team-nike 컬렉션 추가 후 담당 기능에 대한 API 테스트 추가

## 6. DB 확인
- API 서버가 MongoDB로 구축되어 있으므로 MongoDB용 GUI인 Compass를 사용하여 데이터베이스를 탐색하고 조작할 수 있음.

### 6.1 Mongodb Compass 설치
- https://www.mongodb.com/try/download/compass 에서 각자 플랫폼에 맞는 설치파일 다운로드 후 기본 옵션으로 설치

### 6.2 데이터베이스 접속
- MongoDB Compass 실행 후 `+` 버튼(Add new connection) 선택

<img src="images/13-01.png" width="640">

- 접속 정보 추가
  - URI: `mongodb+srv://팀client-id:팀비밀번호@openmarket.ehetjb8.mongodb.net/`
    - 팀client-id는 팀별로 부여받은 client-id 입력
    - 팀비밀번호는 client-id 뒤에 `__` 추가
    - 5팀 예시, `mongodb+srv://febc15-vanilla05-ecad:febc15-vanilla05-ecad__@openmarket.ehetjb8.mongodb.net/`
  - Name: vanilla팀번호-프로젝트
    - 5팀 예시, `vanilla05-brunch`
  - Save & Connect

<img src="images/13-02.png" width="640">

- 접속 결과 확인
  - 접속한 데이터베이스의 file_uploads 컬렉션을 선택해서 업로드한 파일의 수가 맞는지 확인(brunch는 17개, nike는 471개)    

<img src="images/13-03.png" width="640">